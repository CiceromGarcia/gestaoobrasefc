<!DOCTYPE html> 
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://*.googleapis.com https://*.firebaseio.com; script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https: data:; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hist√≥rico de Atualiza√ß√µes - Sistema Qu√©ops</title>
  <link rel="stylesheet" href="menu.css"/>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 90%;
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 { text-align: center; color: #007E7A; }

    /* Filtros responsivos */
    .select-container{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      margin:10px 0;
      align-items:flex-end;
    }
    .select-container .form-group{
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      min-width: 200px;
      flex: 1 1 100%;
    }
    @media (min-width: 600px){
      .select-container .form-group{ flex: 1 1 calc(50% - 12px); }
    }
    @media (min-width: 900px){
      .select-container .form-group{ flex: 1 1 calc(33.333% - 12px); }
    }
    .select-container label{
      font-weight:bold;
      font-size:14px;
      text-align:left;
      margin-bottom:6px;
      padding-left:3px;
      min-height:18px;
    }

    select, button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background:#fff;
    }

    /* Resumo do projeto */
    .resumo-projeto{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 8px 0 6px;
    }
    .info-box{
      background:#f8f8f8;
      border:1px solid #e5e5e5;
      border-radius:8px;
      padding:10px;
      text-align:center;
    }
    .info-box strong{
      color:#007E7A;
      display:block;
      margin-bottom:4px;
    }

    .over-budget { color:#C62828; font-weight:bold; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th { background-color: #007E7A; color: white; }

    .info { text-align: center; padding: 10px; color: #777; }

    .btn-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }
    button {
      cursor: pointer;
      background-color: #009975;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 5px;
      font-size: 14px;
      width: auto;
      min-width: 140px;
      transition: 0.3s;
    }
    button:hover { background-color: #007E7A; }

    .linha-total-avanco td { background: #f7fffd; font-weight: bold; }
  </style>
<script>
function esc(v){
  if(v===undefined||v===null) return '';
  return String(v).replace(/[&<>"']/g, function(s){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]);
  });
}
</script>
</head>
<body>
  <div class="container">
    <h1>üìú Hist√≥rico de Atualiza√ß√µes</h1>

    <div class="select-container">
      <div class="form-group">
        <label for="selectRegional">Selecione a Regional:</label>
        <select id="selectRegional">
          <option value="">Carregando...</option>
        </select>
      </div>

      <div class="form-group">
        <label for="selectProjeto">Selecione o Projeto:</label>
        <select id="selectProjeto">
          <option value="">Selecione uma regional primeiro</option>
        </select>
      </div>
      <!-- Localidade √© injetada via JS aqui -->
    </div>

    <!-- RESUMO DO PROJETO -->
    <div class="resumo-projeto" id="resumoProjeto" hidden>
      <div class="info-box">
        <strong>Data de In√≠cio</strong>
        <span id="resumoInicio">-</span>
      </div>
      <div class="info-box">
        <strong>Data de T√©rmino</strong>
        <span id="resumoTermino">-</span>
      </div>
      <div class="info-box">
        <strong>Custo Or√ßado (R$)</strong>
        <span id="resumoCusto">-</span>
      </div>
      <div class="info-box">
        <strong>Custo Executado (R$)</strong>
        <span id="resumoExecutado">-</span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Data da Atualiza√ß√£o</th>
          <th>Investimento</th>
          <th>Avan√ßo F√≠sico (%)</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tabelaHistorico">
        <tr><td colspan="4" class="info">Selecione um projeto para visualizar o hist√≥rico.</td></tr>
      </tbody>
    </table>

    <div class="btn-container">
      <button id="btnVoltar">‚¨Ö Voltar ao Menu</button>
      <button id="btnImprimir">üñ® Imprimir P√°gina</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyCIN_N1vkthW3G9E7HubFg-C_61-WnFSRU",
        authDomain: "queops-84feb.firebaseapp.com",
        projectId: "queops-84feb",
        storageBucket: "queops-84feb.appspot.com",
        messagingSenderId: "415710636047",
        appId: "1:415710636047:web:58feb0b3fa8b5bcc199b7a"
      });
    }
    try { firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION); } catch(e){}
    window.db = firebase.firestore();

    // ‚úÖ S√≥ come√ßa a carregar dados depois de restaurar a sess√£o
    firebase.auth().onAuthStateChanged(function(user){
      if (!user) {
        const next = encodeURIComponent(location.pathname + location.search);
        location.replace('login.html?next=' + next);
      } else {
        window.__AUTH_OK__ = true;
        if (typeof window.__startHistorico === 'function') {
          window.__startHistorico();
        }
      }
    });
  </script>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    window.__startHistorico = () => {
      const db = window.db;

      const selectRegional  = document.getElementById("selectRegional");
      const selectProjeto   = document.getElementById("selectProjeto");
      const tabelaHistorico = document.getElementById("tabelaHistorico");
      const btnVoltar       = document.getElementById("btnVoltar");
      const btnImprimir     = document.getElementById("btnImprimir");

      const resumoWrap      = document.getElementById("resumoProjeto");
      const resumoInicio    = document.getElementById("resumoInicio");
      const resumoTermino   = document.getElementById("resumoTermino");
      const resumoCusto     = document.getElementById("resumoCusto");
      const resumoExecutado = document.getElementById("resumoExecutado");

      // Din√¢micos
      let selectLocalidade = null;

      let custoOrcadoAtual = 0;
      let cacheProjetosRegional = [];

      const fmtBRL = v => Number(v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
      const fmtDT  = ts => ts?.toDate ? ts.toDate().toLocaleDateString("pt-BR") : "-";
      const fmtPct = v => `${(Number(v || 0)).toFixed(2)}%`;

      const fmtDataSimples = (val) => {
        if (!val) return "-";
        if (val.toDate) return val.toDate().toLocaleDateString("pt-BR");
        if (typeof val === "string") {
          const d = new Date(val);
          return isNaN(d) ? val : d.toLocaleDateString("pt-BR");
        }
        return "-";
      };

      const toNum = (v) => {
        if (typeof v === "number") return v;
        if (typeof v === "string") {
          return Number(
            v.replace(/\s/g, "")
             .replace("R$", "")
             .replace(/\./g, "")
             .replace(",", ".")
             .replace("%", "")
          ) || 0;
        }
        return 0;
      };

      // Normaliza√ß√£o do status
      function normalizaStatus(txt){
        const s = String(txt || "").trim().toLowerCase();
        if (!s) return "";
        if (s.includes("andament")) return "Em andamento";
        if (s.includes("conclu"))   return "Conclu√≠do";
        return s; // outros valores
      }

      // Busca o √∫ltimo statusNovo da obra
      async function obterUltimoStatus(projetoId){
        const snap = await db.collection("projetos_atualizados")
          .where("projetoId","==", projetoId)
          .orderBy("dataAtualizacao","desc")
          .limit(1)
          .get();
        if (snap.empty) return "";
        const d = snap.docs[0].data();
        return normalizaStatus(d.statusNovo);
      }

      // Injeta Localidade entre Regional e Projeto (sem alterar HTML fixo)
      function ensureFiltroLocalidade(){
        const barra = document.querySelector('.select-container');
        const grpProjeto = document.querySelector('label[for="selectProjeto"]')?.closest('.form-group');

        if (!document.getElementById('selectLocalidade')) {
          const fg = document.createElement('div');
          fg.className = 'form-group';
          fg.id = 'grpLocalidade';
          fg.innerHTML = `
            <label for="selectLocalidade">Localidade:</label>
            <select id="selectLocalidade">
              <option value="">Todas</option>
            </select>`;
          if (grpProjeto) barra.insertBefore(fg, grpProjeto); else barra.appendChild(fg);
        } else {
          const fg = document.getElementById('selectLocalidade').closest('.form-group');
          if (fg && grpProjeto && fg.nextSibling !== grpProjeto) {
            barra.insertBefore(fg, grpProjeto);
          }
        }

        selectLocalidade = document.getElementById('selectLocalidade');
        selectLocalidade.onchange = carregarProjetos;
      }

      async function carregarRegionais() {
        const snap = await db.collection("projetos").get();
        const regionais = [...new Set(snap.docs.map(d => d.data().regional).filter(Boolean))].sort();
        selectRegional.innerHTML = regionais.length
          ? `<option value="">Selecione a regional</option>` +
            regionais.map(r => `<option value="${esc(r)}">${esc(r)}</option>`).join("")
          : `<option value="">Nenhuma regional encontrada</option>`;

        ensureFiltroLocalidade();
      }

      async function carregarProjetos() {
        selectProjeto.innerHTML = `<option value="">Carregando...</option>`;
        limparHistoricoETotal();
        resumoWrap.hidden = true;

        const regionalSelecionada = selectRegional.value;
        if (!regionalSelecionada) {
          selectProjeto.innerHTML = `<option value="">Selecione uma regional primeiro</option>`;
          popularLocalidades([]);
          return;
        }

        // 1) Busca projetos da regional
        const snap = await db.collection("projetos")
          .where("regional", "==", regionalSelecionada)
          .get();

        // 2) Monta base e puxa √∫ltimo status de cada projeto (em paralelo)
        const base = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        const statusList = await Promise.all(
          base.map(p => obterUltimoStatus(p.id).catch(()=> "")) // tolerante a erro
        );

        // 3) Anexa status normalizado √† base
        cacheProjetosRegional = base.map((p, idx) => ({ ...p, __statusObra: statusList[idx] }));

        // 4) Filtra somente "Em andamento" e "Conclu√≠do"
        cacheProjetosRegional = cacheProjetosRegional.filter(p =>
          p.__statusObra === "Em andamento" || p.__statusObra === "Conclu√≠do"
        );

        // 5) Popular localidades com base no conjunto filtrado
        popularLocalidades(cacheProjetosRegional);

        // 6) Aplica filtro de localidade (se houver)
        const locSel = (selectLocalidade?.value || '').toLowerCase();
        const projetosFiltrados = cacheProjetosRegional.filter(p =>
          !locSel || String(p.localidade || '').toLowerCase() === locSel
        );

        if (!projetosFiltrados.length) {
          selectProjeto.innerHTML = `<option value="">Nenhum projeto encontrado</option>`;
          tabelaHistorico.innerHTML = `<tr><td colspan="4">Nenhum projeto nessa combina√ß√£o.</td></tr>`;
          return;
        }

        // 7) Popula <select> de projetos
        let opts = `<option value="">Selecione um projeto</option>`;
        projetosFiltrados.forEach(p => {
          opts += `<option value="${p.id}">${esc(p.nomeProjeto || p.nome || "Sem nome")}</option>`;
        });
        selectProjeto.innerHTML = opts;
      }

      function popularLocalidades(lista){
        if (!selectLocalidade) return;
        const locs = [...new Set(lista.map(p => String(p.localidade || '').trim()).filter(Boolean))]
          .sort((a,b)=>a.localeCompare(b,'pt-BR'));
        const sel = selectLocalidade;
        const antiga = sel.value;
        sel.innerHTML = `<option value="">Todas</option>` + locs.map(l=>`<option value="${esc(l)}">${esc(l)}</option>`).join('');
        if (locs.includes(antiga)) sel.value = antiga;
      }

      function limparHistoricoETotal(){
        tabelaHistorico.innerHTML = `<tr><td colspan="4">Selecione um projeto para visualizar o hist√≥rico.</td></tr>`;
        const totalRow = document.getElementById('linhaTotalAvanco');
        if (totalRow) totalRow.remove();
      }

      async function carregarResumoProjeto(projetoId) {
        resumoInicio.textContent    = "-";
        resumoTermino.textContent   = "-";
        resumoCusto.textContent     = "-";
        resumoExecutado.textContent = "-";
        resumoExecutado.classList.remove("over-budget");
        resumoWrap.hidden = true;

        const doc = await db.collection("projetos").doc(projetoId).get();
        if (!doc.exists) return;

        const p = doc.data();
        custoOrcadoAtual = toNum(p.investimento ?? p.custoOrcado ?? 0);

        resumoInicio.textContent  = fmtDataSimples(p.dataInicio);
        resumoTermino.textContent = fmtDataSimples(p.dataTermino);
        resumoCusto.textContent   = fmtBRL(custoOrcadoAtual);
        resumoWrap.hidden = false;
      }

      async function carregarHistorico() {
        tabelaHistorico.innerHTML = `<tr><td colspan="4">Carregando hist√≥rico...</td></tr>`;
        const totalRowOld = document.getElementById('linhaTotalAvanco');
        if (totalRowOld) totalRowOld.remove();

        const projetoId = selectProjeto.value;
        if (!projetoId) {
          limparHistoricoETotal();
          resumoWrap.hidden = true;
          return;
        }

        await carregarResumoProjeto(projetoId);

        const snap = await db.collection("projetos_atualizados")
          .where("projetoId", "==", projetoId)
          .orderBy("dataAtualizacao", "desc")
          .get();

        if (snap.empty) {
          tabelaHistorico.innerHTML = `<tr><td colspan="4">Nenhuma atualiza√ß√£o encontrada para este projeto.</td></tr>`;
          resumoExecutado.textContent = fmtBRL(0);
          resumoWrap.hidden = false;
          renderLinhaTotalAvanco(0);
          return;
        }

        let totalExecutado = 0;
        let html = "";
        snap.forEach(doc => {
          const d = doc.data();
          totalExecutado += toNum(d.investimentoNovo);
          html += `
            <tr>
              <td>${fmtDT(d.dataAtualizacao)}</td>
              <td>${fmtBRL(d.investimentoNovo)}</td>
              <td data-pct="${toNum(d.avancoFisicoNovo)}">${fmtPct(d.avancoFisicoNovo)}</td>
              <td>${esc(d.statusNovo) || "-"}</td>
            </tr>`;
        });

        tabelaHistorico.innerHTML = html;

        resumoExecutado.textContent = fmtBRL(totalExecutado);
        if (totalExecutado > custoOrcadoAtual) {
          resumoExecutado.classList.add("over-budget");
        }
        resumoWrap.hidden = false;

        somarPercentualHistorico();
      }

      function renderLinhaTotalAvanco(totalNumero){
        const old = document.getElementById('linhaTotalAvanco');
        if (old) old.remove();

        const tr = document.createElement('tr');
        tr.id = 'linhaTotalAvanco';
        tr.className = 'linha-total-avanco';
        tr.innerHTML = `
          <td></td>
          <td></td>
          <td><strong>Œ£ ${totalNumero.toFixed(2).replace('.', ',')}%</strong></td>
          <td></td>
        `;
        tabelaHistorico.appendChild(tr);
      }

      function somarPercentualHistorico(){
        let soma = 0;
        Array.from(tabelaHistorico.querySelectorAll('tr')).forEach(tr=>{
          const tds = tr.querySelectorAll('td');
          if (tds.length !== 4) return;
          if (tr.id === 'linhaTotalAvanco') return;
          const cell = tr.querySelector('td:nth-child(3)');
          const val = cell ? toNum(cell.getAttribute('data-pct') || cell.textContent) : 0;
          soma += val;
        });
        renderLinhaTotalAvanco(soma);
      }

      btnVoltar.addEventListener("click", () => (window.location.href = "menu.html"));
      btnImprimir.addEventListener("click", () => window.print());

      selectRegional.addEventListener("change", carregarProjetos);
      selectProjeto.addEventListener("change", carregarHistorico);

      carregarRegionais();
    };

    if (window.__AUTH_OK__) {
      window.__startHistorico();
    }
  });
  </script>
</body>
</html>
