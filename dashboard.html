<!DOCTYPE html>    
<html lang="pt-BR">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://*.googleapis.com https://*.firebaseio.com; script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https: data:; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projetos Cadastrados - Sistema Qu√©ops</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f1f1f1;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        header {
            background-color: #007E7A;
            color: white;
            padding: 15px;
            font-size: 22px;
            font-weight: bold;
        }

        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            table-layout: fixed;
        }

        th, td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
            line-height: 1.25;
        }

        th {
            background-color: #007E7A;
            color: white;
            font-size: 14px;
        }

        button {
            background-color: #007E7A;
            color: white;
            border: none;
            padding: 10px 15px;
            margin-top: 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0ABB98;
        }

        .filtros-container { margin: 15px; }
        .filtros-container select { padding: 6px; margin-left: 5px; margin-right: 10px; }

        a { color: #007E7A; text-decoration: underline; cursor: pointer; }

        .link-desabilitado{
            color:#777 !important;
            text-decoration:none !important;
            pointer-events:none;
            cursor: default;
        }

        /* larguras por coluna */
        #tabelaProjetos th:nth-child(1), #tabelaProjetos td:nth-child(1) { width: 7%; }
        #tabelaProjetos th:nth-child(2), #tabelaProjetos td:nth-child(2) { width: 28%; }
        #tabelaProjetos th:nth-child(3), #tabelaProjetos td:nth-child(3) { width: 16%; }
        #tabelaProjetos th:nth-child(4), #tabelaProjetos td:nth-child(4) { width: 10%; }
        #tabelaProjetos th:nth-child(5), #tabelaProjetos td:nth-child(5) { width: 11%; }
        #tabelaProjetos th:nth-child(6), #tabelaProjetos td:nth-child(6) { width: 12%; }
        #tabelaProjetos th:nth-child(7), #tabelaProjetos td:nth-child(7) { width: 8%; }
        #tabelaProjetos th:nth-child(8), #tabelaProjetos td:nth-child(8) { width: 8%; }
        #tabelaProjetos th:nth-child(9), #tabelaProjetos td:nth-child(9) { width: 10%; }

        /* ellipsis em todas as colunas */
        #tabelaProjetos th,
        #tabelaProjetos td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* quebra apenas em Nome e Localidade */
        #tabelaProjetos th:nth-child(2),
        #tabelaProjetos td:nth-child(2),
        #tabelaProjetos th:nth-child(3),
        #tabelaProjetos td:nth-child(3) {
            white-space: normal;
            word-break: break-word;
            text-align: left;
            overflow: visible;
            text-overflow: clip;
        }
        #tabelaProjetos td:nth-child(2) a,
        #tabelaProjetos td:nth-child(3) a {
            white-space: inherit;
            overflow: visible;
            text-overflow: clip;
        }

        @media (max-width: 1200px){
            #tabelaProjetos th:nth-child(2), #tabelaProjetos td:nth-child(2){ width: 30%; }
            #tabelaProjetos th:nth-child(3), #tabelaProjetos td:nth-child(3){ width: 18%; }
            #tabelaProjetos th:nth-child(6), #tabelaProjetos td:nth-child(6){ width: 14%; }
        }
        @media (max-width: 992px){
            #tabelaProjetos th:nth-child(1), #tabelaProjetos td:nth-child(1){ width: 8%; }
            #tabelaProjetos th:nth-child(2), #tabelaProjetos td:nth-child(2){ width: 34%; }
            #tabelaProjetos th:nth-child(3), #tabelaProjetos td:nth-child(3){ width: 20%; }
            #tabelaProjetos th:nth-child(4), #tabelaProjetos td:nth-child(4){ width: 10%; }
            #tabelaProjetos th:nth-child(6), #tabelaProjetos td:nth-child(6){ width: 12%; }
            #tabelaProjetos th:nth-child(7), #tabelaProjetos td:nth-child(7){ width: 8%; }
            #tabelaProjetos th:nth-child(8), #tabelaProjetos td:nth-child(8){ width: 8%; }
            #tabelaProjetos th:nth-child(9), #tabelaProjetos td:nth-child(9){ width: 10%; }
        }
        @media (max-width: 768px){
            #tabelaProjetos th:nth-child(2), #tabelaProjetos td:nth-child(2){ width: 40%; }
            #tabelaProjetos th:nth-child(3), #tabelaProjetos td:nth-child(3){ width: 22%; }
            #tabelaProjetos th:nth-child(5), #tabelaProjetos td:nth-child(5){ width: 10%; }
            #tabelaProjetos th:nth-child(7), #tabelaProjetos td:nth-child(7){ width: 7%; }
            #tabelaProjetos th:nth-child(8), #tabelaProjetos td:nth-child(8){ width: 7%; }
        }

        /* ===== Toolbar de edi√ß√£o (n√£o altera estrutura da tabela) ===== */
        .edit-toolbar{
            position: fixed; left: 50%; transform: translateX(-50%);
            bottom: 18px; background: #ffffff; border: 1px solid #ddd; box-shadow: 0 6px 18px rgba(0,0,0,.12);
            padding: 8px 10px; border-radius: 10px; display: none; gap:8px; z-index: 9999;
        }
        .edit-toolbar button{
            padding:8px 12px; border-radius:8px; font-size:13px; border:none; cursor:pointer;
        }
        .btn-salvar{ background:#0A8F86; color:#fff; }
        .btn-cancelar{ background:#eaeaea; color:#333; }
        .editando td{ background:#f7fffd; }
        .cel-edit input, .cel-edit select{
            width:100%; box-sizing:border-box; padding:6px 8px; border:1px solid #bbb; border-radius:6px; font-size:13px;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>

    <header>üìë Projetos Cadastrados</header>

    <!-- Filtros -->
    <div class="filtros-container">
        <label for="filtroRegional">Regional:</label>
        <select id="filtroRegional" onchange="filtrarProjetos()">
            <option value="">Todas</option>
            <option value="Regional 1">Regional 1</option>
            <option value="Regional 2">Regional 2</option>
            <option value="Regional 3">Regional 3</option>
            <option value="S√£o Lu√≠s">S√£o Lu√≠s</option>
        </select>

        <label for="filtroLocalidade">Localidade:</label>
        <select id="filtroLocalidade" onchange="filtrarProjetos()">
            <option value="">Todas</option>
            <option value="Arari">Arari</option>
            <option value="Vit√≥ria do Mearim">Vit√≥ria do Mearim</option>
            <option value="Santa In√™s">Santa In√™s</option>
            <option value="Marab√°">Marab√°</option>
            <option value="Nova Vida">Nova Vida</option>
            <option value="A√ßail√¢ndia">A√ßail√¢ndia</option>
            <option value="S√£o Pedro d‚Äô√Ågua Branca">S√£o Pedro d‚Äô√Ågua Branca</option>
            <option value="Itain√≥polis">Itain√≥polis</option>
            <option value="S√£o Lu√≠s">S√£o Lu√≠s</option>
        </select>

        <label for="filtroStatus">Status:</label>
        <select id="filtroStatus" onchange="filtrarProjetos()">
            <option value="">Todos</option>
            <option value="Planejado">Planejado</option>
            <option value="Em andamento">Em andamento</option>
            <option value="Atrasada">Atrasada</option>
            <option value="Conclu√≠do">Conclu√≠do</option>
        </select>
        <!-- O filtro Centro de Custo e o total ser√£o inseridos dinamicamente aqui -->
    </div>

    <table id="tabelaProjetos">
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Nome do Projeto</th>
                <th>Localidade</th>
                <th>Regional</th>
                <th>Apropria√ß√£o</th>
                <th>Custo or√ßado (R$)</th>
                <th>Data In√≠cio</th>
                <th>Data T√©rmino</th>
                <th>Status</th> 
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="9">Nenhum projeto cadastrado.</td>
            </tr>
        </tbody>
    </table>

    <!-- Bot√£o √∫nico -->
    <button onclick="window.location.href='menu.html'">‚Üê Voltar ao Menu</button>

    <!-- Toolbar flutuante de edi√ß√£o -->
    <div id="toolbar" class="edit-toolbar">
        <button class="btn-salvar" id="btnSalvar">Salvar</button>
        <button class="btn-cancelar" id="btnCancelar">Cancelar</button>
    </div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCIN_N1vkthW3G9E7HubFg-C_61-WnFSRU",
    authDomain: "queops-84feb.firebaseapp.com",
    projectId: "queops-84feb",
    storageBucket: "queops-84feb.appspot.com",
    messagingSenderId: "415710636047",
    appId: "1:415710636047:web:58feb0b3fa8b5bcc199b7a"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  window.auth = auth;
  auth.setPersistence(firebase.auth.Auth.Persistence.SESSION).catch(()=>{});
  const db = firebase.firestore();
  let listaProjetos = [];

  /* üîó Mapeamento Regional -> Localidades (acentua√ß√£o id√™ntica √† tabela) */
  const REGIONAL_LOCALIDADES = {
    "Regional 1": ["Altamira","Arari","Auzil√¢ndia","Mineirinho","Santa In√™s","Vila Pindar√©","Vit√≥ria do Mearim"],
    "Regional 2": ["A√ßail√¢ndia","Nova Vida"],
    "Regional 3": ["Itain√≥polis","Marab√°","S√£o Pedro d‚Äô√Ågua Branca"],
    "S√£o Lu√≠s":  ["S√£o Lu√≠s"]
  };
  let DEFAULT_LOCALIDADES = []; // capturadas do select ao carregar

  function atualizarLocalidades(preservarSelecao = true){
    const selRegional   = document.getElementById('filtroRegional');
    const selLocalidade = document.getElementById('filtroLocalidade');
    if(!selRegional || !selLocalidade) return;

    const regional = selRegional.value.trim();
    const lista = REGIONAL_LOCALIDADES[regional] || DEFAULT_LOCALIDADES;

    const selecionadaAntes = selLocalidade.value;
    selLocalidade.innerHTML = "";
    const optTodas = document.createElement('option');
    optTodas.value = "";
    optTodas.textContent = "Todas";
    selLocalidade.appendChild(optTodas);

    (lista || []).forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      selLocalidade.appendChild(o);
    });

    if (preservarSelecao && lista && lista.includes(selecionadaAntes)) {
      selLocalidade.value = selecionadaAntes;
    } else {
      selLocalidade.value = "";
    }
  }

  (function protegerPagina(){
    auth.onAuthStateChanged(function(user){
      if (!user) {
        location.replace('login.html');
      }
    });
  })();

  function esc(v){
    return String(v ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function normalizarStatus(txt) {
    if (!txt) return "";
    const s = String(txt).trim().toLowerCase();
    if (s.includes("conclu")) return "Conclu√≠do";
    if (s.includes("andament")) return "Em andamento";
    if (s.includes("atras")) return "Atrasada";
    if (s.includes("planej")) return "Planejado";
    if (s.includes("paralis")) return "Paralisada";
    return txt;
  }

  // Helpers edi√ß√£o e formata√ß√µes
  function parseMoedaBR(v){
    if (v == null) return 0;
    return Number(String(v).replace(/[R$\s\.]/g,'').replace(',','.')) || 0;
  }
  function fmtMoedaBR(n){
    return 'R$ ' + (Number(n)||0).toLocaleString('pt-BR',{minimumFractionDigits:2});
  }
  // yyyy-mm-dd -> dd/mm/aaaa | dd/mm/aaaa permanece | fallback Date
  function fmtDataBR(str){
    if(!str) return '';
    const s = String(str).trim();
    const mISO = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(mISO) return `${mISO[3]}/${mISO[2]}/${mISO[1]}`;
    const mBR = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(mBR) return s;
    const d = new Date(s);
    if(!isNaN(d)) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yyyy = d.getFullYear();
      return `${dd}/${mm}/${yyyy}`;
    }
    return s;
  }

  // üîí Caixa de senha com m√°scara
  function pedirSenhaAntesDeSalvar(){
    return new Promise((resolve) => {
      const bg = document.createElement('div');
      bg.style.position = 'fixed';
      bg.style.inset = '0';
      bg.style.background = 'rgba(0,0,0,.45)';
      bg.style.display = 'flex';
      bg.style.alignItems = 'center';
      bg.style.justifyContent = 'center';
      bg.style.zIndex = '10000';

      const box = document.createElement('div');
      box.style.background = '#fff';
      box.style.borderRadius = '12px';
      box.style.boxShadow = '0 10px 30px rgba(0,0,0,.18)';
      box.style.padding = '18px 16px';
      box.style.width = 'min(360px, 92vw)';
      box.style.fontFamily = 'Arial, sans-serif';

      const titulo = document.createElement('div');
      titulo.textContent = 'üîí Digite a senha para salvar as altera√ß√µes';
      titulo.style.fontWeight = 'bold';
      titulo.style.marginBottom = '10px';

      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = 'Senha';
      input.autocomplete = 'off';
      input.style.width = '100%';
      input.style.boxSizing = 'border-box';
      input.style.padding = '10px 12px';
      input.style.border = '1px solid #bbb';
      input.style.borderRadius = '8px';
      input.style.fontSize = '14px';
      input.style.margin = '6px 0 12px';

      const rowBtns = document.createElement('div');
      rowBtns.style.display = 'flex';
      rowBtns.style.gap = '8px';
      rowBtns.style.justifyContent = 'flex-end';

      const btnCancelar = document.createElement('button');
      btnCancelar.textContent = 'Cancelar';
      btnCancelar.style.background = '#eaeaea';
      btnCancelar.style.color = '#333';
      btnCancelar.style.border = 'none';
      btnCancelar.style.padding = '8px 12px';
      btnCancelar.style.borderRadius = '8px';
      btnCancelar.style.cursor = 'pointer';

      const btnOk = document.createElement('button');
      btnOk.textContent = 'OK';
      btnOk.style.background = '#0A8F86';
      btnOk.style.color = '#fff';
      btnOk.style.border = 'none';
      btnOk.style.padding = '8px 12px';
      btnOk.style.borderRadius = '8px';
      btnOk.style.cursor = 'pointer';

      function fechar(ret){
        document.removeEventListener('keydown', onKey);
        bg.remove();
        resolve(ret);
      }
      function confirmar(){
        const ok = input.value.trim() === '4272';
        fechar(ok);
        if(!ok) alert('Senha incorreta.');
      }
      function onKey(e){
        if(e.key === 'Escape'){ e.preventDefault(); fechar(false); }
        if(e.key === 'Enter'){ e.preventDefault(); confirmar(); }
      }

      btnCancelar.onclick = () => fechar(false);
      btnOk.onclick = confirmar;
      document.addEventListener('keydown', onKey);

      rowBtns.appendChild(btnCancelar);
      rowBtns.appendChild(btnOk);
      box.appendChild(titulo);
      box.appendChild(input);
      box.appendChild(rowBtns);
      bg.appendChild(box);
      document.body.appendChild(bg);

      setTimeout(()=>input.focus(), 0);
    });
  }

  async function getUltimaAtualizacao(projetoId) {
    try {
      const snap = await db.collection("projetos_atualizados")
        .where("projetoId", "==", projetoId)
        .orderBy("dataAtualizacao", "desc")
        .limit(1)
        .get();
      if (!snap.empty) return snap.docs[0].data();
      return null;
    } catch (e) {
      const snap = await db.collection("projetos_atualizados")
        .where("projetoId", "==", projetoId)
        .get();
      if (snap.empty) return null;
      let ultima = null;
      snap.forEach(doc => {
        const d = doc.data();
        let dt = d.dataAtualizacao;
        if (dt && typeof dt.toDate === "function") dt = dt.toDate();
        else if (typeof dt === "string") {
          const t = new Date(dt);
          if (!isNaN(t)) dt = t;
        }
        if (!ultima || (dt && ultima.dt && dt > ultima.dt)) {
          ultima = { dt, dados: d };
        }
      });
      return ultima ? ultima.dados : null;
    }
  }

  async function carregarProjetos() {
    const tbody = document.querySelector("#tabelaProjetos tbody");
    tbody.innerHTML = "";
    listaProjetos = [];

    try {
      const snapshot = await db.collection("projetos").get();
      if (snapshot.empty) {
        tbody.innerHTML = "<tr><td colspan='9'>Nenhum projeto cadastrado.</td></tr>";
        return;
      }

      const promessas = snapshot.docs.map(async (doc) => {
        const p = { id: doc.id, ...doc.data() };
        const ult = await getUltimaAtualizacao(p.id);

        const investimento = Number(p.investimento || 0);
        if (ult && ult.avancoFisicoNovo != null) {
          p._avancoCalc = Number(ult.avancoFisicoNovo);
        } else {
          const invAcum = ult ? Number(ult.investimentoAcumulado || 0) : 0;
          p._avancoCalc = investimento > 0 ? (invAcum / investimento) * 100 : 0;
        }

        if (ult && ult.statusNovo) {
          p._statusCalc = normalizarStatus(ult.statusNovo);
        } else {
          const hoje = new Date();
          const dataTermino = p.dataTermino ? new Date(p.dataTermino) : null;
          const av = Number(p._avancoCalc || 0);
          if (av >= 100) p._statusCalc = "Conclu√≠do";
          else if (dataTermino && hoje > dataTermino && av < 100) p._statusCalc = "Atrasada";
          else if (av > 0 && av < 100) p._statusCalc = "Em andamento";
          else p._statusCalc = "Planejado";
        }

        listaProjetos.push(p);
      });

      await Promise.all(promessas);

      // cria filtro centro de custo e total ap√≥s carregar os dados
      ensureFiltroCentroCusto();
      atualizarTabela();
      filtrarProjetos();
    } catch (err) {
      console.error("Erro ao buscar projetos:", err);
      tbody.innerHTML = "<tr><td colspan='9'>Erro ao carregar projetos.</td></tr>";
    }
  }

  function atualizarTabela() {
    const tbody = document.querySelector("#tabelaProjetos tbody");
    tbody.innerHTML = "";

    let contador = 1;
    listaProjetos.forEach(p => {
      const investimentoNum = parseFloat(p.investimento || 0);
      const investimentoFmt = "R$ " + investimentoNum.toLocaleString('pt-BR', { minimumFractionDigits: 2 });

      const idLink = encodeURIComponent(String(p.id || ""));
      const nome = esc(p.nomeProjeto || p.nome || "");
      const localidade = esc(p.localidade || "");
      const regional = esc(p.regional || "");
      const centroCusto = esc(p.centroCusto || "");
      const dataInicio = fmtDataBR(p.dataInicio || "");
      const dataTermino = fmtDataBR(p.dataTermino || "");
      const status = esc(p._statusCalc || "Planejado");

      const statusNorm = String(p._statusCalc || "")
        .normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
      const isConcluido = statusNorm.includes('concluido');

      const linkHtml = isConcluido
        ? `<a class="link-desabilitado" aria-disabled="true" tabindex="-1">${nome}</a>`
        : `<a href="atualizar.html?id=${idLink}">${nome}</a>`;

      const tr = document.createElement('tr');
      tr.setAttribute('data-id', p.id);
      tr.innerHTML = `
          <td>#${esc(String(contador).padStart(3, '0'))}</td>
          <td class="cel-nome">${linkHtml}</td>
          <td class="cel-local">${localidade}</td>
          <td class="cel-regional">${regional}</td>
          <td class="cel-cc">${centroCusto}</td>
          <td class="cel-custo">${esc(investimentoFmt)}</td>
          <td class="cel-di">${dataInicio}</td>
          <td class="cel-dt">${dataTermino}</td>
          <td class="cel-status">${status}</td>
      `;
      tbody.appendChild(tr);

      if(!isConcluido){
        tr.addEventListener('dblclick', ()=> iniciarEdicao(tr));
      }
      contador++;
    });

    if (contador === 1) {
      tbody.innerHTML = "<tr><td colspan='9'>Nenhum projeto encontrado.</td></tr>";
    }
  }

  /* ====== Filtro Centro de Custo (injetado) + Total ====== */
  function ensureFiltroCentroCusto(){
    const barra = document.querySelector('.filtros-container');
    if(!barra) return;

    // cria label/select se n√£o existir
    if(!document.getElementById('filtroCentroCusto')){
      const lbl = document.createElement('label');
      lbl.htmlFor = 'filtroCentroCusto';
      lbl.textContent = 'Centro de Custo:';

      const sel = document.createElement('select');
      sel.id = 'filtroCentroCusto';
      sel.onchange = filtrarProjetos;
      sel.style.padding = '6px';
      sel.style.marginLeft = '5px';
      sel.style.marginRight = '10px';

      // insere logo ap√≥s o filtro Localidade
      barra.appendChild(lbl);
      barra.appendChild(sel);
    }

    // popula as op√ß√µes com base nos dados carregados
    const sel = document.getElementById('filtroCentroCusto');
    const valores = Array.from(new Set(
      (listaProjetos || []).map(p => String(p.centroCusto||'').trim()).filter(Boolean)
    )).sort((a,b)=>a.localeCompare(b,'pt-BR'));

    sel.innerHTML = '';
    const optTodas = document.createElement('option');
    optTodas.value = '';
    optTodas.textContent = 'Todos';
    sel.appendChild(optTodas);
    valores.forEach(v=>{
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      sel.appendChild(o);
    });

    // cria/garante selo de total
    if(!document.getElementById('totalFiltrado')){
      const total = document.createElement('span');
      total.id = 'totalFiltrado';
      total.style.marginLeft = '12px';
      total.style.fontWeight = 'bold';
      total.style.color = '#007E7A';
      total.textContent = 'Total filtrado: R$ 0,00';
      barra.appendChild(total);
    }
  }

  /* ===== Edi√ß√£o inline (sem alterar estrutura) ===== */
  let linhaEditando = null;

  function iniciarEdicao(tr){
    if(linhaEditando && linhaEditando !== tr){
      cancelarEdicao();
    }
    linhaEditando = tr;
    tr.classList.add('editando');

    const original = {
      nomeHTML: tr.querySelector('.cel-nome').innerHTML,
      local: tr.querySelector('.cel-local').textContent,
      regional: tr.querySelector('.cel-regional').textContent,
      cc: tr.querySelector('.cel-cc').textContent,
      custo: tr.querySelector('.cel-custo').textContent,
      di: tr.querySelector('.cel-di').textContent,
      dt: tr.querySelector('.cel-dt').textContent,
      status: tr.querySelector('.cel-status').textContent
    };
    tr._orig = original;

    const nomeTexto = original.nomeHTML.replace(/<[^>]*>/g,'');
    tr.querySelector('.cel-nome').classList.add('cel-edit');
    tr.querySelector('.cel-nome').innerHTML = `<input type="text" value="${nomeTexto}">`;

    tr.querySelector('.cel-local').classList.add('cel-edit');
    tr.querySelector('.cel-local').innerHTML = `<input type="text" value="${original.local}">`;

    tr.querySelector('.cel-regional').classList.add('cel-edit');
    tr.querySelector('.cel-regional').innerHTML = `<input type="text" value="${original.regional}">`;

    tr.querySelector('.cel-cc').classList.add('cel-edit');
    tr.querySelector('.cel-cc').innerHTML = `<input type="text" value="${original.cc}">`;

    tr.querySelector('.cel-custo').classList.add('cel-edit');
    tr.querySelector('.cel-custo').innerHTML = `<input type="text" value="${original.custo}">`;

    tr.querySelector('.cel-di').classList.add('cel-edit');
    // para o input date, converte de dd/mm/aaaa -> yyyy-mm-dd
    const diISO = (function(){ const m=original.di.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); return m?`${m[3]}-${m[2]}-${m[1]}`:''; })();
    tr.querySelector('.cel-di').innerHTML = `<input type="date" value="${diISO}">`;

    tr.querySelector('.cel-dt').classList.add('cel-edit');
    const dtISO = (function(){ const m=original.dt.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); return m?`${m[3]}-${m[2]}-${m[1]}`:''; })();
    tr.querySelector('.cel-dt').innerHTML = `<input type="date" value="${dtISO}">`;

    tr.querySelector('.cel-status').classList.add('cel-edit');
    tr.querySelector('.cel-status').innerHTML = `
      <select>
        <option ${/planejado/i.test(original.status)?'selected':''}>Planejado</option>
        <option ${/andamento/i.test(original.status)?'selected':''}>Em andamento</option>
        <option ${/atrasad/i.test(original.status)?'selected':''}>Atrasada</option>
        <option ${/conclu/i.test(original.status)?'selected':''}>Conclu√≠do</option>
      </select>`;

    mostrarToolbar();
  }

  function mostrarToolbar(){
    document.getElementById('toolbar').style.display = 'flex';
  }
  function esconderToolbar(){
    document.getElementById('toolbar').style.display = 'none';
  }

  async function salvarEdicao(){
    if(!linhaEditando) return;
    // üîí verifica senha antes de prosseguir (ass√≠ncrono)
    if(!(await pedirSenhaAntesDeSalvar())){
      alert('Senha incorreta ou cancelada. As altera√ß√µes n√£o foram salvas.');
      return;
    }

    const tr = linhaEditando;
    const val = sel => tr.querySelector(sel+' input, '+sel+' select')?.value || '';

    const dados = {
      nomeProjeto : val('.cel-nome'),
      localidade  : val('.cel-local'),
      regional    : val('.cel-regional'),
      centroCusto : val('.cel-cc'),
      investimento: parseMoedaBR(val('.cel-custo')),
      dataInicio  : tr.querySelector('.cel-di input').value || '',
      dataTermino : tr.querySelector('.cel-dt input').value || '',
    };
    const statusNovo = tr.querySelector('.cel-status select').value;

    try{
      await db.collection('projetos').doc(tr.dataset.id).update(dados);
      await db.collection('projetos_atualizados').add({
        projetoId: tr.dataset.id,
        dataAtualizacao: new Date(),
        statusNovo,
        investimentoAcumulado: dados.investimento ?? 0
      });

      const it = listaProjetos.find(x=>x.id===tr.dataset.id);
      if(it){
        it.nomeProjeto = dados.nomeProjeto;
        it.localidade  = dados.localidade;
        it.regional    = dados.regional;
        it.centroCusto = dados.centroCusto;
        it.investimento= dados.investimento;
        it.dataInicio  = dados.dataInicio;
        it.dataTermino = dados.dataTermino;
        it._statusCalc = statusNovo;
      }
      linhaEditando = null;
      esconderToolbar();
      atualizarTabela();
      filtrarProjetos();
      alert('Projeto atualizado com sucesso!');
    }catch(e){
      console.error(e);
      alert('Erro ao salvar: ' + e.message);
    }
  }

  function cancelarEdicao(){
    if(!linhaEditando) return;
    const tr = linhaEditando;
    const o = tr._orig || {};

    tr.querySelector('.cel-nome').innerHTML = o.nomeHTML || '';
    tr.querySelector('.cel-local').textContent = o.local || '';
    tr.querySelector('.cel-regional').textContent = o.regional || '';
    tr.querySelector('.cel-cc').textContent = o.cc || '';
    tr.querySelector('.cel-custo').textContent = o.custo || '';
    tr.querySelector('.cel-di').textContent = o.di || '';
    tr.querySelector('.cel-dt').textContent = o.dt || '';
    tr.querySelector('.cel-status').textContent = o.status || '';

    tr.classList.remove('editando');
    tr.querySelectorAll('.cel-edit').forEach(el=>el.classList.remove('cel-edit'));
    delete tr._orig;
    linhaEditando = null;
    esconderToolbar();
  }

  // Toolbar
  document.getElementById('btnSalvar').addEventListener('click', salvarEdicao);
  document.getElementById('btnCancelar').addEventListener('click', cancelarEdicao);

  /* üîß Atualizamos localidades ANTES de aplicar os filtros */
  function filtrarProjetos() {
    atualizarLocalidades(true);

    const filtroRegional = document.getElementById('filtroRegional').value.toLowerCase();
    const filtroLocalidade = document.getElementById('filtroLocalidade').value.toLowerCase();
    const filtroStatus = document.getElementById('filtroStatus').value.toLowerCase();
    const filtroCC = (document.getElementById('filtroCentroCusto')?.value || '').toLowerCase();

    let total = 0;

    document.querySelectorAll("#tabelaProjetos tbody tr").forEach(linha => {
      const cells = linha.querySelectorAll('td');
      if(cells.length < 9) return; // linha "Nenhum projeto..."

      const regional = cells[3].textContent.toLowerCase();
      const localidade = cells[2].textContent.toLowerCase();
      const centroCusto = cells[4].textContent.toLowerCase();
      const status = cells[8].textContent.toLowerCase();

      const visivel = (
        (filtroRegional === "" || regional.includes(filtroRegional)) &&
        (filtroLocalidade === "" || localidade.includes(filtroLocalidade)) &&
        (filtroStatus === "" || status.includes(filtroStatus)) &&
        (filtroCC === "" || centroCusto.includes(filtroCC))
      );

      linha.style.display = visivel ? "" : "none";
      if(visivel){
        // soma custo da coluna 6
        const custoTxt = cells[5].querySelector('input') ? cells[5].querySelector('input').value : cells[5].textContent;
        total += parseMoedaBR(custoTxt);
      }
    });

    const alvoTotal = document.getElementById('totalFiltrado');
    if(alvoTotal){
      alvoTotal.textContent = `Total filtrado: ${fmtMoedaBR(total)}`;
    }
  }

  window.onload = async () => {
    const selLocalidade = document.getElementById('filtroLocalidade');
    DEFAULT_LOCALIDADES = Array.from(selLocalidade.options)
      .map(o => o.value)
      .filter(v => v !== "");

    await carregarProjetos();

    const params = new URLSearchParams(location.search);
    const alvo = params.has("localidade") ? params.get("localidade") : "";

    const sel = document.getElementById('filtroLocalidade');
    if (sel && alvo !== "") {
      for (const opt of sel.options) {
        if (opt.value.toLowerCase() === String(alvo).toLowerCase()) {
          sel.value = opt.value;
          break;
        }
      }
    }
    atualizarLocalidades(false);
    filtrarProjetos();

    // Teclas de atalho enquanto edita
    document.addEventListener('keydown', (e)=>{
      if(!linhaEditando) return;
      if(e.key === 'Escape'){ e.preventDefault(); cancelarEdicao(); }
      if(e.key === 'Enter'){  e.preventDefault(); salvarEdicao(); }
    });
  };
</script>

</body>
</html>

