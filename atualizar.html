<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atualizar Projeto - Sistema Qu√©ops</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f1f1f1; margin:0; padding:0; }
    .container { width:90%; max-width:600px; margin:50px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    h2 { text-align:center; margin-bottom:20px; }
    label { font-weight:bold; display:block; margin-top:10px; }
    input, select { width:98%; padding:6px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
    input[readonly], select[disabled] { background:#f5f5f5; font-weight:bold; }
    .actions { display:flex; gap:8px; margin-top:16px; }
    button { background:#007E7A; color:#fff; border:none; padding:10px 15px; border-radius:5px; cursor:pointer; }
    button:hover { background:#0ABB98; }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h2>Atualizar Projeto</h2>

    <form id="formAtualizar">
      <label for="nomeProjeto">Nome do Projeto:</label>
      <input type="text" id="nomeProjeto" readonly>

      <label for="localidade">Localidade:</label>
      <input type="text" id="localidade" readonly>

      <label for="regional">Regional:</label>
      <input type="text" id="regional" readonly>

      <label for="centroCusto">Apropria√ß√£o:</label>
      <input type="text" id="centroCusto" readonly>

      <label for="investimento">Adicionar Custo (R$):</label>
      <input type="text" id="investimento" placeholder="Digite o valor adicional">

      <label for="avancoFisico">Adicionar Avan√ßo F√≠sico (%):</label>
      <input type="number" id="avancoFisico" step="0.01" max="100" placeholder="Digite o avan√ßo f√≠sico">

      <div class="actions">
        <button type="button" id="btnSalvar">üíæ Salvar Altera√ß√µes</button>
        <button type="button" onclick="window.location.href='dashboard.html'">‚¨Ö Voltar</button>
      </div>
    </form>
  </div>

  <script>
    // ===== Firebase Config =====
    const firebaseConfig = {
      apiKey: "AIzaSyCIN_N1vkthW3G9E7HubFg-C_61-WnFSRU",
      authDomain: "queops-84feb.firebaseapp.com",
      projectId: "queops-84feb",
      storageBucket: "queops-84feb.firebasestorage.app",
      messagingSenderId: "415710636047",
      appId: "1:415710636047:web:58feb0b3fa8b5bcc199b7a"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== Util =====
    const params = new URLSearchParams(window.location.search);
    const projetoId = params.get("id");
    let dadosOriginais = {};

    // Carregar dados do projeto base (s√≥ pra exibir na tela)
    async function carregarProjeto() {
      if (!projetoId) {
        alert("‚ùå Nenhum projeto selecionado!");
        window.location.href = "dashboard.html";
        return;
      }
      const doc = await db.collection("projetos").doc(projetoId).get();
      if (!doc.exists) {
        alert("‚ö† Projeto n√£o encontrado!");
        window.location.href = "dashboard.html";
        return;
      }
      dadosOriginais = doc.data();
      document.getElementById("nomeProjeto").value = dadosOriginais.nomeProjeto || dadosOriginais.nome || "";
      document.getElementById("localidade").value = dadosOriginais.localidade || "";
      document.getElementById("regional").value = dadosOriginais.regional || "";
      document.getElementById("centroCusto").value = dadosOriginais.centroCusto || "";
    }

    // Formatar moeda no input
    document.getElementById('investimento').addEventListener('input', function(e) {
      let v = e.target.value.replace(/\D/g, '');
      if (v) {
        v = (parseInt(v, 10)/100).toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
        e.target.value = v;
      } else {
        e.target.value = '';
      }
    });

    // Helper para converter BRL -> n√∫mero
    function parseBRL(str) {
      const only = String(str||'').replace(/\D/g,'');
      return only ? Number(only)/100 : 0;
    }

    // Salvar APENAS os incrementos em projetos_atualizados
    async function atualizarProjeto() {
      if (!projetoId) return;

      const btn = document.getElementById("btnSalvar");
      btn.disabled = true; // (ajuste) evita duplo clique

      try {
        // Incrementos informados agora
        const valorInput = document.getElementById("investimento").value;
        const custoAdicional = parseBRL(valorInput);                    // (ajuste) parser robusto
        const avancoAdicional = parseFloat(document.getElementById("avancoFisico").value) || 0;

        if (custoAdicional <= 0 && avancoAdicional <= 0) {
          alert("Informe ao menos Custo adicional ou Avan√ßo f√≠sico.");
          return;
        }

        // Buscar acumulados anteriores SOMENTE na cole√ß√£o projetos_atualizados
        let somaInvestAnterior = 0;
        let somaAvancoAnterior = 0;

        // (ajuste) sem orderBy para n√£o exigir √≠ndice
        const snap = await db.collection("projetos_atualizados")
          .where("projetoId", "==", projetoId)
          .get();

        snap.forEach(d => {
          const x = d.data();
          somaInvestAnterior += Number(x.investimentoNovo || 0);
          somaAvancoAnterior += Number(x.avancoFisicoNovo || 0);
        });

        // Novos acumulados
        let investimentoAcumulado = somaInvestAnterior + custoAdicional;
        let avancoFisicoAcumulado = somaAvancoAnterior + avancoAdicional;
        if (avancoFisicoAcumulado > 100) avancoFisicoAcumulado = 100;

        // Status calculado pelo ACUMULADO de avan√ßo
        let statusNovo = "Planejado";
        if (avancoFisicoAcumulado > 0 && avancoFisicoAcumulado < 100) statusNovo = "Em andamento";
        if (avancoFisicoAcumulado === 100) statusNovo = "Conclu√≠do";
        if (investimentoAcumulado > 0 && avancoFisicoAcumulado === 0) statusNovo = "Paralisado";

        // Gravar NOVA LINHA somente com incrementos (e campos acumulados de apoio)
        await db.collection("projetos_atualizados").add({
          projetoId: projetoId,
          nomeProjeto: dadosOriginais.nomeProjeto || dadosOriginais.nome || "",
          localidade: dadosOriginais.localidade || "",
          regional: dadosOriginais.regional || "",
          centroCusto: dadosOriginais.centroCusto || "",
          investimentoNovo: custoAdicional,             // incremento
          avancoFisicoNovo: avancoAdicional,            // incremento
          investimentoAcumulado: investimentoAcumulado, // apoio
          avancoFisicoAcumulado: avancoFisicoAcumulado, // apoio
          statusNovo: statusNovo,
          dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("‚úÖ Atualiza√ß√£o registrada!");
        window.location.href = "indicadores.html";
      } catch (err) {
        console.error("Erro ao salvar atualiza√ß√£o:", err);
        alert("Erro ao salvar. Veja o console (F12).");
      } finally {
        btn.disabled = false; // (ajuste)
      }
    }

    // Eventos
    document.getElementById("btnSalvar").addEventListener("click", atualizarProjeto);
    window.addEventListener("load", carregarProjeto);
  </script>
</body>
</html>
